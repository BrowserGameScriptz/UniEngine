function preg_quote(a){return(a+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1")}function padTime(a){a=""+a;if(a.length==1){return"0"+a}else if(a.length==0){return"00"}return a}function createMessage(a,b){var c=[],d="",e=new Date((a.d+ServerStamp)*1e3);if(UserAuth>=90){c.push('<a class="delMsg" href="#"></a>');c.push('<a class="edit" href="chat_edit.php?mode='+a.id+'"></a>')}else{c.push('<a class="reportMsg" href="#" title="'+JSLang["ToolTip_ReportMsg"]+'"></a>')}if(typeof b!=="undefined"&&LastSeenID_Used===false){if(a.id==b){d=" lastSeen";LastSeenID_Used=true}}if(c.length>0){c='<th valign="top">'+c.join(" ")+"</th>"}else{c=""}e=padTime(e.getHours())+":"+padTime(e.getMinutes())+", "+padTime(e.getDate())+" "+MonthsLang[e.getMonth()+1]+" "+e.getFullYear();return'<tr id="sbmsg_'+a.id+'" class="doFadeIn '+d+'"><th class="usr aright" valign="top" nowrap><a href="#" class="usrRef usrColor_'+Messages.users[a.u].c+'" title="'+JSLang["usrRef"]+'">'+Messages.users[a.u].n+'</a> <a href="profile.php?uid='+a.u+'" class="usrColor_'+Messages.users[a.u].c+'" target="_blank" title="'+JSLang["profile"]+'">#</a></th><th class="msg aleft">'+a.t+'</th><th class="dt aright" valign="top" nowrap>('+e+")</th>"+c+"</tr>"}function addSmiley(a){MsgBox.val(MsgBox.val()+a).focus()}function AddReference(a){MsgBox.val(MsgBox.val()+a+": ").focus()}function showMessage(){var a=null,b=false,c=false,d=false;if(Messages.init===false){a={init:true,rid:RoomID}}else{a={rid:RoomID,fID:Messages.firstID,lID:Messages.lastID,lGet:Messages.lastGet,lCnt:Messages.msgCount}}ActivityBox.show(0);AjaxGet=$.get("ajax/chat.msg.php",a).complete(function(a,e){ActivityBox.hide(0);if(e=="success"){var f=false;if(ReconnectCounter>0||GetError_FatalOccured===true){GetError_FatalOccured=false;ReconnectCounter=0;clearInterval(ReconnectInterval);UnThrowError(true,true)}var g={};if(a.responseText!=""){g=$.parseJSON(a.responseText)}if(g.Err!=null){f=true;ThrowError(JSLang_Errors["getErr_"+g.Err],true,true,true)}if(g.onl!=null){var h=[];var i="";var j=[];for(var k in g.onl){i=g.onl[k].split("|");h.push('<a href="#" class="usrRef usrColor_'+i[2]+" "+(i[3]!=null&&i[3]==1?"usrInv":"")+'" title="'+JSLang["usrRef"]+'">'+i[1]+'</a> <a href="profile.php?uid='+i[0]+'" class="usrColor_'+i[2]+'" target="_blank" title="'+JSLang["profile"]+'">#</a>');j.push(i[0])}OnlineUsers.html(", "+h.join(", "));if(Messages.init!==false){var l=false;for(var m in j){if($.inArray(j[m],OldOnlineArray)===-1){l=true;break}}if(l===true){LastActivity_Time=(new Date).getTime();LastActivity_Type=2}}OldOnlineArray=j}else{OnlineUsers.html("");OldOnlineArray=[]}if(g.onlCnt==null){g.onlCnt=0}OnlineCount.html(parseInt(g.onlCnt,10)+1);if(f!==true){if(g.cmd=="delall"){Messages={users:{},msgCount:0,firstID:0,lastID:0,lastGet:0};ShoutBoxTable.html("")}else{if(g.usr!=null){d=true;for(var n in g.usr){Messages.users[n]=g.usr[n]}}if(g.edit!=null){d=true;for(var o in g.edit){ShoutBoxTable.find("#sbmsg_"+o+" > .msg").html(g.edit[o].t)}}if(g.del!=null){d=true;var p=false;for(var q in g.del){p=ShoutBoxTable.find("#sbmsg_"+g.del[q]);if(p.length>0){Messages.msgCount-=1;p.remove();if(g.del[q]==Messages.lastID){c=true}else if(g.del[q]==Messages.firstID){b=true}}}}if(g.newm!=null){LastActivity_Time=(new Date).getTime();d=true;var r=0;var s=0;if(Messages.msgCount==0){var t="";for(r in g.newm){s=g.newm[r].id;if(Messages.firstID>s||Messages.firstID==0){Messages.firstID=s}if(Messages.lastID<s){Messages.lastID=s}t+=createMessage(g.newm[r],LastSeenID);Messages.msgCount+=1}ShoutBoxTable.fadeTo(0,.001);ShoutBoxTable.append(t);$(".doFadeIn").removeClass("doFadeIn");ShoutBoxTable.fadeTo(350,1)}else{LastActivity_Type=1;var u="";var v="";for(r in g.newm){s=g.newm[r].id;if(Messages.firstID>s){Messages.firstID=s;u+=createMessage(g.newm[r])}else{if(Messages.lastID<s){Messages.lastID=s}if(g.newm[r].t.search(YourNickname_RegExp)!==-1){g.newm[r].t=g.newm[r].t.replace(YourNicknameReplace_RegExp,TPL_NicknameReplace);UserMentioned=true}if(TabActive===false){NewMsgCount+=1}else{UserMentioned=false}v+=createMessage(g.newm[r])}Messages.msgCount+=1}if(TabActive===false){var w=OriginalTitle+" ("+NewMsgCount+")";document.title=w;if(UserMentioned===true){if(TitleFlashInterval!==false){clearInterval(TitleFlashInterval)}TitleFlashState=1;TitleFlashInterval=setInterval(function(){if(TitleFlashState===1){document.title=JSLang["mentioned"];TitleFlashState=2}else{document.title=w;TitleFlashState=1}},1e3)}}if(u!=""){ShoutBoxTable.append(u);u=""}if(v!=""){ShoutBoxTable.prepend(v);v=""}$(".doFadeIn").fadeTo(350,1).removeClass("doFadeIn")}}if(d===true){Messages.lastGet=parseInt((new Date).getTime()/1e3,10)-ServerStamp}if(Messages.msgCount==0){Messages.firstID=0;Messages.lastID=0}else{if(Messages.msgCount==1){if(c===true){Messages.lastID=parseInt(ShoutBoxTable.find("tr:first").attr("id").replace("sbmsg_",""),10)}Messages.firstID=Messages.lastID}else{if(c===true){Messages.lastID=parseInt(ShoutBoxTable.find("tr:first").attr("id").replace("sbmsg_",""),10)}if(b===true){Messages.firstID=parseInt(ShoutBoxTable.find("tr:last").attr("id").replace("sbmsg_",""),10)}}}}}if(g.lmMC!=null){var x=LeftMenu_Messages.children("#lm_msgc");if(x.length>0){x.html("("+g.lmMC+")")}else{LeftMenu_Messages.addClass("orange").append('<b id="lm_msgc">('+g.lmMC+")</b>")}}else{LeftMenu_Messages.children("#lm_msgc").remove().end().removeClass("orange")}if(LastActivity_Type>0){if(LastActivity_Type==1){GetTimeout_Current=GetTimeout_MinVal}else{GetTimeout_Current=GetTimeout_InitVal}LastActivity_Type=0}else{if((new Date).getTime()-LastActivity_Time>=GetTimeout_IdleStart){if(GetTimeout_Current<GetTimeout_MaxVal){GetTimeout_Current+=GetTimeout_AddToIdle_Val}}else{if(GetTimeout_Current<GetTimeout_InitVal){GetTimeout_Current+=GetTimeout_AddToActive_Val}}}if(f!==true){GetTimeout=setTimeout(showMessage,GetTimeout_Current)}}else{if(e!="abort"&&e!="notmodified"){if(ReconnectCounter==0){clearTimeout(ErrorFadeOutTimeout);ThrowError("",true,true,true)}clearInterval(ReconnectInterval);if(ReconnectCounter<MaxReconnectCounts){GetError_FatalOccured=false;ReconnectCounter+=1;ErrorBox.html(ErrorMsg["getError"].replace("{x}",MaxReconnectCounts-ReconnectCounter+1));ReconnectInterval=setTimeout(showMessage,5e3)}else{GetError_FatalOccured=true;ErrorBox.html(ErrorMsg["getErrorFatal"])}}}})}function ThrowError(a,b,c,d){if(typeof a==="undefined"){a=" "}if(typeof b==="undefined"){b=false}if(typeof c==="undefined"){c=false}if(typeof d==="undefined"){d=false}if(b===true){ShoutBoxTable.fadeTo(400,.5)}if(c===true){SendButton.attr("disabled",true);MsgBox.attr("disabled",true)}ErrorBox.html(a).fadeIn(400,function(){if(d===false){ErrorFadeOutTimeout=setTimeout(function(){UnThrowError(b,c)},1500)}})}function UnThrowError(a,b){ErrorBox.fadeOut(400);if(a===true){ShoutBoxTable.fadeTo(400,1)}if(b===true){SendButton.removeAttr("disabled");MsgBox.removeAttr("disabled")}}function AjaxAbort(){if(typeof AjaxGet.readyState!="undefined"){if(AjaxGet.readyState!=4){AjaxGet.abort()}}}var AjaxGet=false;var GetTimeout=false;var MsgBox=false;var OnlineUsers=false;var OnlineCount=false;var LeftMenu_Messages=false;var OldOnlineArray=[];var OriginalTitle="";var TabActive=true;var GetError_FatalOccured=false;var NewMsgCount=0;var LastSeenID_Used=false;var ReconnectCounter=0;var MaxReconnectCounts=3;var TitleFlashState=1;var UserMentioned=false;var Messages={users:{},msgCount:0,firstID:0,lastID:0,lastGet:0};var LastActivity_Time=0;var LastActivity_Type=0;var GetTimeout_MinVal=2500;var GetTimeout_InitVal=5e3;var GetTimeout_MaxVal=3e4;var GetTimeout_IdleStart=6e4;var GetTimeout_Current=GetTimeout_InitVal;var GetTimeout_AddToIdle_Val=1e3;var GetTimeout_AddToActive_Val=500;var AjaxSettings={timeout:4e3};var TPL_NicknameReplace='<b class="skyblue">$1</b>';var ReconnectInterval=false;var ErrorFadeOutTimeout=false;var SettingsInterval=false;var TitleFlashInterval=false;$(document).ready(function(){$.ajaxSetup(AjaxSettings);OriginalTitle=document.title;YourNickname=preg_quote(YourNickname);YourNickname_RegExp=new RegExp(YourNickname,"gi");YourNicknameReplace_RegExp=new RegExp("("+YourNickname+")","gi");MsgBox=$("#msgText");ShoutBoxTable=$("#sbTable");SendButton=$("#msgSend");OnlineUsers=$("#onlineUsers");OnlineCount=$("#onlineCount");ErrorBox=$("#errorBox");ActivityBox=$("#activityBox");SettingsBox=$("#set_Loading");LeftMenu_Messages=$("#lm_msg");showMessage();MsgBox.keypress(function(a){if(a.keyCode==13&&!a.shiftKey){SendButton.click()}});ShoutBoxTable.on("click",".delMsg",function(){clearTimeout(GetTimeout);ThisID=$(this).parent().parent().attr("id").replace("sbmsg_","");ActivityBox.show(0);AjaxAbort();$.get("ajax/chat.del.php",{id:ThisID}).success(function(a){ActivityBox.hide(0);if(a!=1){if(a!=5){FoundError=ErrorMsg["jQueryAjax_delErr_"+a].replace("{$id}",ThisID);NoUnThrow=false}else{FoundError=ErrorMsg["jQueryAjax_notLogged"];NoUnThrow=true}ThrowError(FoundError,false,false,NoUnThrow)}if(a!=5){showMessage()}}).error(function(){ActivityBox.hide(0);showMessage()});return false}).on("click",".reportMsg",function(){ThisID=$(this).parent().parent().attr("id").replace("sbmsg_","");ThisUID=$(this).parent().parent().find("th.usr > a:not(.usrRef)").attr("href").replace("profile.php?uid=","");window.location.href="report.php?type=9&uid="+ThisUID+"&eid="+ThisID;return false});$("#shoutbox").on("click",".usrRef",function(a){a.preventDefault();AddReference($(this).html())});ErrorBox.on("click","#chatReload",function(){if(GetError_FatalOccured!==true){return false}ReconnectCounter=0;showMessage();return false});SendButton.click(function(){if(MsgBox.val()!=""){clearTimeout(GetTimeout);MsgBox.attr("disabled",true);SendButton.attr("disabled",true);ActivityBox.show(0);AjaxAbort();$.post("ajax/chat.add.php",{rid:RoomID,msg:MsgBox.val()}).success(function(a){ActivityBox.hide(0);if(a==1){MsgBox.val("").removeAttr("disabled");SendButton.removeAttr("disabled");showMessage()}else{if(a!=4){FoundError=ErrorMsg["jQueryAjax_postErr_"+a];NoUnThrow=false}else{FoundError=ErrorMsg["jQueryAjax_notLogged"];NoUnThrow=true}ThrowError(FoundError,true,true,NoUnThrow);GetTimeout=setTimeout(showMessage,2500)}}).error(function(){ActivityBox.hide(0);ThrowError(ErrorMsg["jQueryAjax_postError"],true,true);GetTimeout=setTimeout(showMessage,2500)})}});$(".setChg").change(function(){if(SettingsInterval!==false){clearTimeout(SettingsInterval)}SettingsBox.fadeIn(0).attr("src","images/ajax-loader.gif");var a={};var b=function(){return};var c=false;var d=$(this);if($(this).attr("type")=="checkbox"){a[$(this).attr("name")]=$(this).is(":checked");c=function(){d.prop("checked",!d.is(":checked"))};if(a["setChg_1"]!=null){if(a["setChg_1"]===true){b=function(){$("#onlineBox_you").addClass("usrInv")}}else if(a["setChg_1"]===false){b=function(){$("#onlineBox_you").removeClass("usrInv")}}}}else{a[$(this).attr("name")]=$(this).val();c=function(){d.val("")}}$.post("ajax/chat.settings.php",a).success(function(a){if(a==1){SettingsBox.attr("src","images/tick.green.png");b()}else{SettingsBox.attr("src","images/tick.red.png");c()}SettingsInterval=setTimeout(function(){SettingsBox.fadeOut(500)},1e3)}).error(function(){SettingsBox.attr("src","images/delete.png");SettingsInterval=setTimeout(function(){SettingsBox.fadeOut(500)},1e3)})});$(window).blur(function(){TabActive=false;if(LastSeenID<Messages.lastID){$("#sbmsg_"+LastSeenID).removeClass("lastSeen");$("#sbmsg_"+Messages.lastID).addClass("lastSeen");LastSeenID=Messages.lastID}}).focus(function(){if(TitleFlashInterval!==false){clearInterval(TitleFlashInterval)}UserMentioned=false;TabActive=true;NewMsgCount=0;document.title=OriginalTitle})})